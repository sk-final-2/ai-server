from langgraph.graph import StateGraph, END
from interview.model import InterviewState
from interview.nodes import (
    first_question_node,
    answer_node,
    analyze_node,
    next_question_node,
)

# âœ… ìƒíƒœì™€ ë‹¤ìŒ ê²½ë¡œë¥¼ dictë¡œ ë¦¬í„´
def router_node(state: InterviewState) -> dict:
    if isinstance(state, dict):
        state = InterviewState(**state)

    if state.is_finished:
        print("ğŸ [router_node] ì¸í„°ë·° ì¢…ë£Œ")
        next_node = "end"
    elif state.step == 0:
        print("ğŸ§­ [router_node] ì²« ì§ˆë¬¸ ìƒì„± íë¦„")
        next_node = "first_question"
    else:
        print("ğŸ§­ [router_node] ë‹µë³€ ìˆ˜ì§‘ íë¦„")
        next_node = "answer"

    return {
        "__state__": state,
        "__next__": next_node
    }

# âœ… create_graph í•¨ìˆ˜
def create_graph():
    print("âœ… FSM ì»´íŒŒì¼ ì‹œì‘")
    builder = StateGraph(InterviewState)

    # ë…¸ë“œ ë“±ë¡
    builder.add_node("first_question", first_question_node)
    builder.add_node("answer", answer_node)
    builder.add_node("analyze", analyze_node)
    builder.add_node("next_question", next_question_node)
    builder.add_node("router", router_node)

    # íë¦„ ì •ì˜
    builder.add_edge("first_question", "answer")
    builder.add_edge("answer", "analyze")
    builder.add_edge("analyze", "next_question")
    builder.add_edge("next_question", "router")

    # ì¡°ê±´ ë¶„ê¸° ì •ì˜
    builder.add_conditional_edges(
        "router",
        condition=lambda state_dict: state_dict["__next__"],
        path_map={
            "first_question": "first_question",
            "answer": "answer",
            "end": END
        }
    )

    builder.set_entry_point("router")
    return builder.compile()